# check if data is already mounted by debugging feature or fstab
mountpoint /data
if [ $? -ne 0 ]; then
	mount -o bind,nosuid,nodev,noexec /mnt/userdata /data
fi

# data partition is now mounted
# find module/firmware image in guestos store and mount
modules=$(find /data/cml/operatingsystems -name modules.img -exec sh -c 'printf "%s  %s\n" "$0" "$1" | sha256sum -c - >/dev/null 2>&1' "$(cat /etc/modules.hash)" {} \; -print -quit)
mount -o loop,nosuid,noexec $modules /lib/modules
firmware=$(find /data/cml/operatingsystems -name firmware.img -exec sh -c 'printf "%s  %s\n" "$0" "$1" | sha256sum -c - >/dev/null 2>&1' "$(cat /etc/firmware.hash)" {} \; -print -quit)
mount -o loop,nosuid,noexec $firmware /lib/firmware

mkdir -p /data/logs

#now modules partition is mounted
echo "Waiting for devices"
for i in {1..4}; do
	echo -n "."
	scan_devices
done

mount -a

mkdir -p /var/volatile/tmp

for suffix in conf sig cert; do
	if [ ! -f "/data/cml/containers/00000000-0000-0000-0000-000000000000.$suffix" ]; then
		cp /data/cml/containers_templates/00000000-0000-0000-0000-000000000000.$suffix /data/cml/containers/00000000-0000-0000-0000-000000000000.$suffix
	fi
done

export PATH="/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin"
